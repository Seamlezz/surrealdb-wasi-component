name: Release Components

on:
  push:
    branches:
      - main
    paths:
      - "crates/**/Cargo.toml"
      - "wit/world.wit"
      - ".github/workflows/release-components.yml"
      - ".github/scripts/detect-releases.sh"
      - ".github/scripts/component-release-notes.sh"
  workflow_dispatch:
    inputs:
      component:
        description: "Force a single component release check"
        required: true
        type: choice
        options:
          - sdk
          - host-adapter
          - wit

permissions:
  contents: write
  packages: write

concurrency:
  group: release-components
  cancel-in-progress: false

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.detect.outputs.matrix }}
      count: ${{ steps.detect.outputs.count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect releasable components
        id: detect
        env:
          BEFORE_SHA: ${{ github.event.before }}
          HEAD_SHA: ${{ github.sha }}
          FORCE_COMPONENT: ${{ github.event_name == 'workflow_dispatch' && inputs.component || '' }}
        run: bash .github/scripts/detect-releases.sh

  publish:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.count != '0'
    strategy:
      fail-fast: false
      matrix:
        component: ${{ fromJson(needs.detect.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
      - name: Validate crates publish token
        if: matrix.component.id != 'wit'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          if [ -z "$CARGO_REGISTRY_TOKEN" ]; then
            echo "Missing CARGO_REGISTRY_TOKEN repository secret"
            exit 1
          fi
      - name: Install task
        if: matrix.component.id == 'wit'
        uses: arduino/setup-task@v2
      - name: Install wkg
        if: matrix.component.id == 'wit'
        run: cargo install wkg --locked
      - name: Authenticate to GHCR
        if: matrix.component.id == 'wit'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GH_TOKEN" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
      - name: Publish component
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          case "${{ matrix.component.id }}" in
            sdk)
              cargo publish --dry-run -p surrealdb-component-sdk
              cargo publish -p surrealdb-component-sdk
              ;;
            host-adapter)
              cargo publish --dry-run -p surrealdb-host-adapter
              cargo publish -p surrealdb-host-adapter
              ;;
            wit)
              task release:publish VERSION=${{ matrix.component.version }}
              ;;
            *)
              echo "Unknown component id: ${{ matrix.component.id }}"
              exit 1
              ;;
          esac
      - name: Generate release notes
        run: |
          bash .github/scripts/component-release-notes.sh \
            "${{ matrix.component.id }}" \
            "${{ matrix.component.version }}" > RELEASE_NOTES.md
      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          case "${{ matrix.component.id }}" in
            sdk) TAG="sdk-v${{ matrix.component.version }}" ;;
            host-adapter) TAG="host-adapter-v${{ matrix.component.version }}" ;;
            wit) TAG="wit-v${{ matrix.component.version }}" ;;
            *)
              echo "Unknown component id: ${{ matrix.component.id }}"
              exit 1
              ;;
          esac
          gh release create "$TAG" \
            --target "${{ github.sha }}" \
            --title "$TAG" \
            --notes-file RELEASE_NOTES.md
